---
// 性能优化组件
---

<!-- 关键资源预加载 -->
<link rel="preload" href="/favicon.svg" as="image" type="image/svg+xml" />

<!-- 字体预加载 -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" /></noscript>

<!-- 关键 CSS 内联 -->
<style>
  /* 关键 CSS - 首屏样式 */
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    line-height: 1.6;
    color: #1f2937;
    background-color: #ffffff;
    margin: 0;
    padding: 0;
  }
  
  .layout {
    display: flex;
    min-height: 100vh;
  }
  
  .main-content {
    flex: 1;
    padding: 2rem;
    max-width: 800px;
    margin: 0 auto;
  }
  
  /* 深色模式支持 */
  @media (prefers-color-scheme: dark) {
    body {
      background-color: #111827;
      color: #f9fafb;
    }
  }
  
  /* 加载动画 */
  .loading {
    opacity: 0;
    animation: fadeIn 0.3s ease-in-out forwards;
  }
  
  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }
</style>

<!-- 图片优化脚本 -->
<script>
  // 图片懒加载
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.classList.remove('lazy');
          imageObserver.unobserve(img);
        }
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      const lazyImages = document.querySelectorAll('img[data-src]');
      lazyImages.forEach(img => imageObserver.observe(img));
    });
  }

  // 预加载下一页链接
  document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('a[href^="/"]');
    const prefetchThreshold = 200; // 200ms 悬停后预加载
    
    links.forEach(link => {
      let prefetchTimeout;
      
      link.addEventListener('mouseenter', () => {
        prefetchTimeout = setTimeout(() => {
          const linkElement = document.createElement('link');
          linkElement.rel = 'prefetch';
          linkElement.href = link.href;
          document.head.appendChild(linkElement);
        }, prefetchThreshold);
      });
      
      link.addEventListener('mouseleave', () => {
        clearTimeout(prefetchTimeout);
      });
    });
  });

  // 性能监控
  window.addEventListener('load', () => {
    // 记录 Core Web Vitals
    if ('web-vital' in window) {
      import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
        getCLS(console.log);
        getFID(console.log);
        getFCP(console.log);
        getLCP(console.log);
        getTTFB(console.log);
      });
    }
  });
</script>

<!-- 服务工作者注册 -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('SW registered: ', registration);
        })
        .catch(registrationError => {
          console.log('SW registration failed: ', registrationError);
        });
    });
  }
</script>
