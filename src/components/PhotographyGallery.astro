---
interface Image {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  caption?: string;
}

interface Props {
  images: Image[];
}

const { images } = Astro.props;
---

<div class="photography-gallery">
  {images.map((image, index) => (
    <div class="gallery-item" data-index={index}>
      <div class="image-wrapper">
        <img
          src={image.src}
          alt={image.alt}
          width={image.width}
          height={image.height}
          loading={index === 0 ? "eager" : "lazy"}
          class="gallery-image"
          data-src={image.src}
        />
        {image.caption && (
          <div class="image-caption">
            <p>{image.caption}</p>
          </div>
        )}
      </div>
    </div>
  ))}
</div>

<!-- 图片查看器模态框 -->
<div id="image-viewer" class="image-viewer" style="display: none;">
  <div class="viewer-overlay"></div>
  <div class="viewer-container">
    <button class="viewer-close" aria-label="关闭图片查看器">×</button>
    <button class="viewer-prev" aria-label="上一张图片">‹</button>
    <button class="viewer-next" aria-label="下一张图片">›</button>
    <div class="viewer-image-container">
      <img id="viewer-image" class="viewer-image" alt="" />
      <div class="viewer-caption">
        <p id="viewer-caption"></p>
        <span id="viewer-counter"></span>
      </div>
    </div>
  </div>
</div>

<style>
  .photography-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
  }

  .gallery-item {
    position: relative;
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .gallery-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  .image-wrapper {
    position: relative;
    aspect-ratio: 16/9;
    overflow: hidden;
  }

  .gallery-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .gallery-item:hover .gallery-image {
    transform: scale(1.05);
  }

  .image-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    color: white;
    padding: 1rem;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }

  .gallery-item:hover .image-caption {
    transform: translateY(0);
  }

  .image-caption p {
    margin: 0;
    font-size: 0.875rem;
    line-height: 1.4;
  }

  /* 图片查看器样式 */
  .image-viewer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
  }

  .viewer-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(4px);
  }

  .viewer-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .viewer-close {
    position: absolute;
    top: 2rem;
    right: 2rem;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 2rem;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
    z-index: 10001;
  }

  .viewer-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .viewer-prev,
  .viewer-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 2rem;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
    z-index: 10001;
  }

  .viewer-prev {
    left: 2rem;
  }

  .viewer-next {
    right: 2rem;
  }

  .viewer-prev:hover,
  .viewer-next:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .viewer-image-container {
    max-width: 90%;
    max-height: 90%;
    position: relative;
  }

  .viewer-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
  }

  .viewer-caption {
    position: absolute;
    bottom: -3rem;
    left: 0;
    right: 0;
    text-align: center;
    color: white;
  }

  .viewer-caption p {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
  }

  .viewer-caption span {
    font-size: 0.875rem;
    opacity: 0.8;
  }

  /* 深色模式 */
  @media (prefers-color-scheme: dark) {
    .gallery-item {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    .gallery-item:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .photography-gallery {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .viewer-container {
      padding: 1rem;
    }

    .viewer-close {
      top: 1rem;
      right: 1rem;
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.5rem;
    }

    .viewer-prev,
    .viewer-next {
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.5rem;
    }

    .viewer-prev {
      left: 1rem;
    }

    .viewer-next {
      right: 1rem;
    }
  }
</style>

<script>
  // 图片查看器功能
  document.addEventListener('DOMContentLoaded', function() {
    const galleryItems = document.querySelectorAll('.gallery-item');
    const imageViewer = document.getElementById('image-viewer');
    const viewerImage = document.getElementById('viewer-image');
    const viewerCaption = document.getElementById('viewer-caption');
    const viewerCounter = document.getElementById('viewer-counter');
    const closeBtn = document.querySelector('.viewer-close');
    const prevBtn = document.querySelector('.viewer-prev');
    const nextBtn = document.querySelector('.viewer-next');
    const overlay = document.querySelector('.viewer-overlay');

    let currentIndex = 0;
    const images = Array.from(galleryItems).map(item => {
      const img = item.querySelector('.gallery-image');
      const caption = item.querySelector('.image-caption p');
      return {
        src: img.src,
        alt: img.alt,
        caption: caption ? caption.textContent : ''
      };
    });

    // 打开图片查看器
    function openViewer(index) {
      currentIndex = index;
      updateViewerImage();
      imageViewer.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    // 关闭图片查看器
    function closeViewer() {
      imageViewer.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // 更新查看器中的图片
    function updateViewerImage() {
      const currentImage = images[currentIndex];
      viewerImage.src = currentImage.src;
      viewerImage.alt = currentImage.alt;
      viewerCaption.textContent = currentImage.caption;
      viewerCounter.textContent = `${currentIndex + 1} / ${images.length}`;
    }

    // 上一张图片
    function prevImage() {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      updateViewerImage();
    }

    // 下一张图片
    function nextImage() {
      currentIndex = (currentIndex + 1) % images.length;
      updateViewerImage();
    }

    // 事件监听器
    galleryItems.forEach((item, index) => {
      item.addEventListener('click', () => openViewer(index));
    });

    closeBtn.addEventListener('click', closeViewer);
    overlay.addEventListener('click', closeViewer);
    prevBtn.addEventListener('click', prevImage);
    nextBtn.addEventListener('click', nextImage);

    // 键盘导航
    document.addEventListener('keydown', function(e) {
      if (imageViewer.style.display === 'block') {
        switch(e.key) {
          case 'Escape':
            closeViewer();
            break;
          case 'ArrowLeft':
            prevImage();
            break;
          case 'ArrowRight':
            nextImage();
            break;
        }
      }
    });

    // 触摸手势支持
    let startX = 0;
    let startY = 0;

    imageViewer.addEventListener('touchstart', function(e) {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    });

    imageViewer.addEventListener('touchend', function(e) {
      if (!startX || !startY) return;

      const endX = e.changedTouches[0].clientX;
      const endY = e.changedTouches[0].clientY;
      const diffX = startX - endX;
      const diffY = startY - endY;

      // 水平滑动切换图片
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX > 0) {
          nextImage();
        } else {
          prevImage();
        }
      }

      startX = 0;
      startY = 0;
    });
  });
</script>
